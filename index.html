<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UD3 - Organizzazione Cantiere | Layout Interattivo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 0.95em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .intro-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 4px;
        }

        .intro-box h2 {
            color: #1565c0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .intro-box p {
            color: #37474f;
            line-height: 1.8;
            margin-bottom: 12px;
        }

        .instructions {
            background: #fff8e1;
            border: 2px dashed #ffa726;
            padding: 20px;
            border-radius: 8px;
            margin: 25px 0;
        }

        .instructions h3 {
            color: #e65100;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .instructions ul {
            margin-left: 20px;
            color: #424242;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .score-display {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
            display: none;
        }

        .score-display.active {
            display: block;
        }

        .score-display h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .score-counter {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }

        .site-layout {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 150px);
            gap: 12px;
            margin-bottom: 30px;
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
        }

        .zone {
            background: white;
            border: 3px solid #bdc3c7;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.3s;
            position: relative;
        }

        .zone.flagged {
            background: #fff3e0;
            border-color: #ff9800;
        }

        .zone-header {
            text-align: center;
            margin-bottom: 8px;
        }

        .zone-icon {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .zone-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.85em;
            line-height: 1.2;
        }

        .zone-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .zone-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .btn-details {
            background: #e3f2fd;
            color: #1976d2;
        }

        .btn-details:hover {
            background: #bbdefb;
        }

        .btn-flag {
            background: #fff3e0;
            color: #f57c00;
        }

        .btn-flag:hover {
            background: #ffe0b2;
        }

        .btn-flag.active {
            background: #ff9800;
            color: white;
        }

        /* Posizioni zone (9 zone su griglia 4x3) */
        .zone-ingresso { grid-column: 1; grid-row: 1; }
        .zone-viabilita-mezzi { grid-column: 2 / 4; grid-row: 1; }
        .zone-baraccamenti { grid-column: 4; grid-row: 1 / 3; }
        .zone-deposito-materiali { grid-column: 1 / 3; grid-row: 2; }
        .zone-gru { grid-column: 3; grid-row: 2; }
        .zone-viabilita-pedoni { grid-column: 1 / 3; grid-row: 3; }
        .zone-scarico { grid-column: 3; grid-row: 3; }
        .zone-servizi { grid-column: 4; grid-row: 3; }
        .zone-rifiuti { grid-column: 1; grid-row: 4; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-icon {
            font-size: 3em;
            margin-right: 15px;
        }

        .modal-title h3 {
            color: #2c3e50;
            font-size: 1.4em;
            margin-bottom: 5px;
        }

        .modal-title p {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .description-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .description-box h4 {
            color: #2c3e50;
            margin-bottom: 12px;
        }

        .description-box p {
            color: #495057;
            line-height: 1.7;
            margin-bottom: 10px;
        }

        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .final-score {
            text-align: center;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .score-badge {
            display: inline-block;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 2em;
            font-weight: bold;
            margin: 20px 0;
        }

        .score-badge.excellent {
            background: #4caf50;
            color: white;
        }

        .score-badge.good {
            background: #ffc107;
            color: #424242;
        }

        .score-badge.poor {
            background: #f44336;
            color: white;
        }

        .analysis-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .analysis-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .zone-result {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #bdc3c7;
        }

        .zone-result.correct {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }

        .zone-result.missed {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .zone-result.false-positive {
            border-left-color: #ff9800;
            background: #fff3e0;
        }

        .zone-result h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zone-result .status {
            font-size: 1.5em;
        }

        .zone-result p {
            color: #495057;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .zone-result ul {
            margin: 10px 0 10px 20px;
            color: #495057;
        }

        .zone-result li {
            margin-bottom: 6px;
            line-height: 1.5;
        }

        .norm-ref {
            background: rgba(255,255,255,0.7);
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            font-style: italic;
            color: #666;
            margin-top: 10px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
            }
            .header, .button-group, .btn, .modal, .score-display {
                display: none !important;
            }
            .no-print {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            .site-layout {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: auto;
            }
            .zone {
                grid-column: span 1 !important;
                grid-row: span 1 !important;
            }
            .button-group {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header no-print">
            <h1>üèóÔ∏è UD3 - Organizzazione e Aree di Lavoro</h1>
            <p>Layout Interattivo: Identificazione Errori Logistici nel Cantiere</p>
        </div>

        <div class="content">
            <div id="intro" class="intro-box">
                <h2>üìã Scenario del Cantiere</h2>
                <p>Sei il <strong>datore di lavoro</strong> di un'impresa affidataria che deve verificare l'organizzazione 
                di un cantiere di ristrutturazione di un edificio commerciale a Milano. Il cantiere √® operativo da 2 settimane, 
                ma non √® stata effettuata alcuna verifica formale del layout.</p>

                <p style="margin-top: 15px;">Il Coordinatore per la Sicurezza in fase di Esecuzione (CSE) ti ha chiesto 
                di ispezionare la disposizione delle aree di lavoro prima dell'arrivo dell'ASL per un controllo programmato.</p>

                <div class="instructions">
                    <h3>üìå Istruzioni</h3>
                    <ul>
                        <li>Osserva il layout del cantiere (9 zone totali)</li>
                        <li>Per ogni zona puoi cliccare <strong>"üìã Vedi Dettagli"</strong> per leggere la situazione organizzativa</li>
                        <li>Se ritieni che una zona presenti errori logistici o organizzativi, clicca <strong>"‚ö†Ô∏è Segnala Errore"</strong></li>
                        <li>Puoi rivedere i dettagli e cambiare idea quante volte vuoi</li>
                        <li>Quando hai finito la valutazione, clicca <strong>"Conferma Valutazione"</strong></li>
                    </ul>
                </div>

                <button class="btn btn-primary" onclick="startInspection()" style="display: block; margin: 20px auto;">
                    Inizia l'Ispezione del Cantiere ‚Üí
                </button>
            </div>

            <div class="score-display" id="scoreDisplay">
                <h3>Zone Segnalate con Errori</h3>
                <div class="score-counter" id="scoreCounter">0 / 9</div>
            </div>

            <div id="siteLayout" class="site-layout" style="display: none;"></div>

            <div class="button-group no-print" id="finalizeBtn" style="display: none;">
                <button class="btn btn-primary" onclick="finalizeInspection()">
                    üìä Conferma Valutazione e Visualizza Risultati
                </button>
            </div>

            <div id="results" class="results-section">
                <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">
                    üìä Report di Ispezione del Cantiere
                </h2>

                <div class="final-score">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Punteggio Finale</h3>
                    <div class="score-badge" id="finalScoreBadge">0/100</div>
                    <p id="finalMessage" style="color: #555; font-size: 1.1em; margin-top: 15px;"></p>
                </div>

                <div class="analysis-section">
                    <h3>üìã Analisi Dettagliata per Zona</h3>
                    <div id="detailedResults"></div>
                </div>

                <div class="button-group no-print">
                    <button class="btn btn-primary" onclick="window.print()">
                        üñ®Ô∏è Stampa Report
                    </button>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        üîÑ Nuova Ispezione
                    </button>
                    <button class="btn btn-secondary" onclick="window.close()">
                        ‚úì Chiudi e Continua
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="zoneModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon" id="modalIcon">üèóÔ∏è</div>
                <div class="modal-title">
                    <h3 id="modalTitle">Titolo Zona</h3>
                    <p>Descrizione della situazione organizzativa</p>
                </div>
            </div>
            <div id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal()">
                    Chiudi
                </button>
            </div>
        </div>
    </div>

    <script>
        const zonesData = {
            'ingresso': {
                icon: 'üö™',
                title: 'Ingresso Cantiere',
                description: 'All\'ingresso del cantiere √® presente un cancello metallico con lucchetto. Non √® presente un cartello identificativo permanente con i dati del committente e delle imprese. Il sistema di badge elettronico non √® stato implementato. Non risulta un registro cartaceo o digitale delle presenze posizionato all\'entrata.',
                hasError: true,
                errorDetails: [
                    'Mancanza di cartello identificativo del cantiere con dati committente e imprese (obbligatorio per art. 90 D.Lgs. 81/2008)',
                    'Assenza di sistema di registrazione delle presenze',
                    'Badge elettronico non implementato (obbligo L. 159/2025 per tracciabilit√† accessi)'
                ],
                norm: 'D.Lgs. 81/2008, art. 90 e 26; Legge 159/2025 (patente a crediti e badge elettronico)'
            },
            'viabilita-mezzi': {
                icon: 'üöõ',
                title: 'Viabilit√† Mezzi',
                description: 'Il percorso per i mezzi d\'opera attraversa l\'intera lunghezza del cantiere. Nello stesso spazio transitano anche i lavoratori a piedi senza separazione fisica. Non sono presenti strisce di demarcazione o segnaletica orizzontale. Agli incroci non ci sono specchi parabolici. La larghezza del percorso √® di circa 4 metri.',
                hasError: true,
                errorDetails: [
                    'La viabilit√† dei mezzi non √® separata fisicamente da quella pedonale (violazione art. 108 D.Lgs. 81/2008)',
                    'Assenza di segnaletica orizzontale (strisce gialle) e verticale (cartelli limite velocit√†)',
                    'Mancano dispositivi di ausilio visivo negli incroci (specchi parabolici)'
                ],
                norm: 'D.Lgs. 81/2008, art. 108 - Viabilit√† nei cantieri; Allegato XVIII punto 1'
            },
            'baraccamenti': {
                icon: 'üè†',
                title: 'Baraccamenti e Uffici',
                description: 'I container prefabbricati sono posizionati a 15 metri dall\'area operativa principale, in zona pianeggiante. Sono dotati di finestre apribili e ventilazione naturale. Le uscite di sicurezza sono chiaramente segnalate e non ostruite. Sono presenti estintori a polvere ABC ogni 10 metri. L\'illuminazione √® garantita da lampade a LED.',
                hasError: false,
                errorDetails: null,
                complianceReason: 'I baraccamenti sono conformi: distanti dall\'area operativa, con vie di fuga libere, illuminazione naturale e aerazione adeguata. Presenti presidi antincendio. Conformi all\'Allegato XIII D.Lgs. 81/2008.',
                norm: 'D.Lgs. 81/2008, Allegato XIII - Requisiti luoghi di lavoro'
            },
            'deposito-materiali': {
                icon: 'üì¶',
                title: 'Deposito Materiali',
                description: 'Il deposito materiali si trova in un\'area coperta vicino all\'ingresso. I sacchi di cemento sono appoggiati direttamente sul pavimento. Accanto ci sono fusti di vernici e solventi nello stesso settore. Il deposito si trova lungo quella che sembrerebbe essere una delle vie di uscita del cantiere. Non sono presenti cartelli che indichino limiti di peso o portata.',
                hasError: true,
                errorDetails: [
                    'I materiali sono depositati lungo una via di fuga (violazione D.M. 3/9/2021 sulla gestione emergenze)',
                    'Assenza di separazione tra materiali incompatibili (cemento, vernici, solventi)',
                    'Mancanza di indicazioni sulla capacit√† di carico dell\'area di stoccaggio',
                    'Stoccaggio a terra senza pallets (rischio umidit√† e degrado materiali)'
                ],
                norm: 'D.Lgs. 81/2008, Allegato IV punto 1.4; D.M. 3 settembre 2021 (antincendio nei cantieri)'
            },
            'gru': {
                icon: 'üèóÔ∏è',
                title: 'Area Gru Torre',
                description: 'La gru torre √® installata nella zona centrale del cantiere. L\'area sottostante il braccio rotante non presenta delimitazioni fisiche n√© transenne. Non ci sono cartelli che vietino l\'accesso o la sosta nella zona di raggio d\'azione. Durante le operazioni di sollevamento, i lavoratori transitano liberamente nell\'area.',
                hasError: true,
                errorDetails: [
                    'L\'area di lavoro della gru non √® delimitata con transenne o barriere fisse',
                    'Manca segnaletica di divieto di accesso e sosta nell\'area di sollevamento',
                    'Assenza di procedure per la gestione del transito durante le operazioni di sollevamento'
                ],
                norm: 'D.Lgs. 81/2008, art. 153 - Protezione contro la caduta di materiali dall\'alto; Allegato VI'
            },
            'viabilita-pedoni': {
                icon: 'üö∂',
                title: 'Viabilit√† Pedonale',
                description: 'Il percorso pedonale principale del cantiere passa direttamente sotto il raggio di azione della gru torre. Non sono presenti tettoie o coperture protettive sopra questo percorso. L\'illuminazione serale √® garantita da lampade a LED montate su pali, ma alcune zone rimangono poco illuminate dopo il tramonto.',
                hasError: true,
                errorDetails: [
                    'Il percorso pedonale passa sotto la zona di sollevamento della gru (rischio caduta materiali)',
                    'Assenza di pensiline, tunnel protettivi o percorsi alternativi',
                    'Illuminazione insufficiente in alcune aree per garantire transiti sicuri nelle ore serali'
                ],
                norm: 'D.Lgs. 81/2008, art. 108 (viabilit√†) e 153 (protezione caduta materiali dall\'alto)'
            },
            'scarico': {
                icon: 'üì•',
                title: 'Zona Scarico',
                description: 'La zona di scarico merci √® delimitata con nastro bianco-rosso e cartelli di avviso. Durante le operazioni di scarico √® sempre presente un operatore a terra che assiste l\'autista nelle manovre di retromarcia. L\'area √® separata dalla viabilit√† principale ed √® ben visibile dall\'ingresso. √à presente segnaletica di limite velocit√†.',
                hasError: false,
                errorDetails: null,
                complianceReason: 'La zona scarico √® correttamente organizzata: delimitata, segnalata e separata dalla viabilit√† principale. Presente moviere durante le operazioni di retromarcia. Conforme alle procedure del Piano Operativo di Sicurezza.',
                norm: 'D.Lgs. 81/2008, art. 96 - Obblighi imprese esecutrici; Allegato VI punto 3'
            },
            'servizi': {
                icon: 'üöª',
                title: 'Servizi Igienici',
                description: 'I servizi igienici sono costituiti da due container WC chimici posizionati vicino ai baraccamenti. Sono presenti lavabi con acqua fredda. Non ci sono armadietti spogliatoio separati per indumenti da lavoro e civili. Il numero di lavoratori presenti in cantiere √® di circa 28 persone. I WC vengono puliti una volta a settimana da ditta esterna.',
                hasError: true,
                errorDetails: [
                    'I servizi sono sottodimensionati per 28 lavoratori (necessari almeno 3 WC secondo Allegato XIII)',
                    'Mancanza di acqua calda per il lavaggio',
                    'Assenza di armadietti spogliatoio separati per indumenti da lavoro e civili',
                    'Frequenza di pulizia insufficiente (richiesta giornaliera per cantieri con oltre 20 addetti)'
                ],
                norm: 'D.Lgs. 81/2008, Allegato XIII - Locali di riposo, spogliatoi, servizi igienici'
            },
            'rifiuti': {
                icon: 'üóëÔ∏è',
                title: 'Deposito Rifiuti',
                description: 'Il deposito rifiuti √® un\'area all\'aperto con tre cassoni metallici. In un cassone sono presenti mattoni, calcinacci e sacchi di cemento vuoti. In un altro ci sono barattoli di vernici, flaconi di solventi e stracci sporchi mischiati. I contenitori non hanno coperchio e non presentano etichette con codice CER. Non √® presente documentazione relativa alla gestione dei rifiuti in cantiere.',
                hasError: true,
                errorDetails: [
                    'Rifiuti pericolosi (vernici, solventi) mischiati con rifiuti inerti senza separazione',
                    'Contenitori privi di copertura e identificazione con codice CER',
                    'Assenza di registro di carico/scarico rifiuti',
                    'Mancanza di documentazione sul trasportatore autorizzato'
                ],
                norm: 'D.Lgs. 152/2006 (Testo Unico Ambiente - gestione rifiuti); D.Lgs. 81/2008, art. 161 (gestione rifiuti in cantiere)'
            }
        };

        let flaggedZones = [];

        function startInspection() {
            document.getElementById('intro').style.display = 'none';
            document.getElementById('scoreDisplay').classList.add('active');
            document.getElementById('finalizeBtn').style.display = 'flex';
            populateLayout();
        }

        function populateLayout() {
            const layout = document.getElementById('siteLayout');
            layout.style.display = 'grid';
            
            Object.keys(zonesData).forEach(zoneId => {
                const zone = zonesData[zoneId];
                const zoneDiv = document.createElement('div');
                zoneDiv.className = `zone zone-${zoneId}`;
                zoneDiv.innerHTML = `
                    <div class="zone-header">
                        <div class="zone-icon">${zone.icon}</div>
                        <div class="zone-label">${zone.title}</div>
                    </div>
                    <div class="zone-actions">
                        <button class="zone-btn btn-details" onclick="viewDetails('${zoneId}')">
                            üìã Vedi Dettagli
                        </button>
                        <button class="zone-btn btn-flag" id="flag-${zoneId}" onclick="toggleFlag('${zoneId}')">
                            ‚ö†Ô∏è Segnala Errore
                        </button>
                    </div>
                `;
                layout.appendChild(zoneDiv);
            });
        }

        function viewDetails(zoneId) {
            const zone = zonesData[zoneId];
            const modal = document.getElementById('zoneModal');
            
            document.getElementById('modalIcon').textContent = zone.icon;
            document.getElementById('modalTitle').textContent = zone.title;
            
            document.getElementById('modalBody').innerHTML = `
                <div class="description-box">
                    <h4>üìã Situazione Organizzativa</h4>
                    <p>${zone.description}</p>
                </div>
            `;
            
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('zoneModal').classList.remove('show');
        }

        function toggleFlag(zoneId) {
            const btn = document.getElementById(`flag-${zoneId}`);
            const zoneDiv = document.querySelector(`.zone-${zoneId}`);
            
            if (flaggedZones.includes(zoneId)) {
                flaggedZones = flaggedZones.filter(id => id !== zoneId);
                btn.classList.remove('active');
                btn.textContent = '‚ö†Ô∏è Segnala Errore';
                zoneDiv.classList.remove('flagged');
            } else {
                flaggedZones.push(zoneId);
                btn.classList.add('active');
                btn.textContent = '‚úì Segnalato';
                zoneDiv.classList.add('flagged');
            }
            
            updateCounter();
        }

        function updateCounter() {
            document.getElementById('scoreCounter').textContent = `${flaggedZones.length} / 9`;
        }

        function finalizeInspection() {
            document.getElementById('siteLayout').style.display = 'none';
            document.getElementById('scoreDisplay').style.display = 'none';
            document.getElementById('finalizeBtn').style.display = 'none';
            showResults();
        }

        function showResults() {
            document.getElementById('results').classList.add('active');

            const zonesWithErrors = Object.keys(zonesData).filter(id => zonesData[id].hasError);
            const correctlyFlagged = flaggedZones.filter(id => zonesData[id].hasError);
            const missedErrors = zonesWithErrors.filter(id => !flaggedZones.includes(id));
            const falsePositives = flaggedZones.filter(id => !zonesData[id].hasError);

            const correctScore = correctlyFlagged.length * 14;
            const missedPenalty = missedErrors.length * 10;
            const falsePenalty = falsePositives.length * 7;
            const totalScore = Math.max(0, Math.min(100, correctScore - missedPenalty - falsePenalty));

            const badge = document.getElementById('finalScoreBadge');
            const message = document.getElementById('finalMessage');

            if (totalScore >= 80) {
                badge.className = 'score-badge excellent';
                badge.textContent = `${totalScore}/100 - Eccellente`;
                message.textContent = 'Hai identificato correttamente le criticit√† organizzative. Ottima capacit√† di analisi del layout cantiere.';
            } else if (totalScore >= 60) {
                badge.className = 'score-badge good';
                badge.textContent = `${totalScore}/100 - Buono`;
                message.textContent = 'Buona performance, ma alcune criticit√† sono sfuggite. Rivedi i principi di organizzazione del cantiere.';
            } else {
                badge.className = 'score-badge poor';
                badge.textContent = `${totalScore}/100 - Da migliorare`;
                message.textContent = 'L\'analisi presenta lacune. Ti consigliamo di rivedere l\'UD3 prima di procedere.';
            }

            const detailedDiv = document.getElementById('detailedResults');
            let resultsHTML = '';

            correctlyFlagged.forEach(id => {
                const zone = zonesData[id];
                resultsHTML += `
                    <div class="zone-result correct">
                        <h4><span class="status">‚úì</span> ${zone.title} - Errore Identificato Correttamente</h4>
                        <p><strong>Le criticit√† organizzative presenti erano:</strong></p>
                        <ul>
                            ${zone.errorDetails.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                        <div class="norm-ref">üìñ ${zone.norm}</div>
                    </div>
                `;
            });

            missedErrors.forEach(id => {
                const zone = zonesData[id];
                resultsHTML += `
                    <div class="zone-result missed">
                        <h4><span class="status">‚úó</span> ${zone.title} - Errore Non Identificato</h4>
                        <p><strong>‚ö†Ô∏è Questa zona presentava criticit√† organizzative che non hai segnalato:</strong></p>
                        <ul>
                            ${zone.errorDetails.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                        <div class="norm-ref">üìñ ${zone.norm}</div>
                    </div>
                `;
            });

            falsePositives.forEach(id => {
                const zone = zonesData[id];
                resultsHTML += `
                    <div class="zone-result false-positive">
                        <h4><span class="status">‚ö†Ô∏è</span> ${zone.title} - Falso Allarme</h4>
                        <p><strong>Hai segnalato questa zona, ma era conforme:</strong></p>
                        <p>${zone.complianceReason}</p>
                        <div class="norm-ref">üìñ ${zone.norm}</div>
                    </div>
                `;
            });

            const correctlyNotFlagged = Object.keys(zonesData).filter(id => 
                !zonesData[id].hasError && !flaggedZones.includes(id)
            );
            
            if (correctlyNotFlagged.length > 0) {
                resultsHTML += `
                    <div class="zone-result correct">
                        <h4><span class="status">‚úì</span> Zone Conformi Identificate Correttamente</h4>
                        <p>Hai giustamente NON segnalato le seguenti zone conformi:</p>
                        <ul>
                            ${correctlyNotFlagged.map(id => `<li><strong>${zonesData[id].title}</strong></li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            detailedDiv.innerHTML = resultsHTML;
        }

        document.getElementById('zoneModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>
